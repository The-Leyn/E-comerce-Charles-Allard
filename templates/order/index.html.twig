{% extends 'base.html.twig' %}

{% block title %}Hello OrderController!
{% endblock %}

{% block stylesheets %}
	<link href="{{ asset('css/order.css') }}" rel="stylesheet"/>
{% endblock %}
{# {% block javascripts %}
	<script src="{{ asset('js/single-product.js') }}" defer></script>
{% endblock %} #}
{% block body %}
	<section>
		{# <div class="address-part">
			<h2>Informations de
				<span>Livraison</span>
			</h2>
			<h3>Choisisez votre adresse de livraison :</h3>
			<p>Vous pouvez ajouter une adresse de livraison depuis votre profil
				<a href="#">Ajouter une adresse</a>.</p>
			{{ form_start(form) }}
			{% for address in form.addresses %}
				<div
					class="address-row">
					{{ form_widget(address) }}

					{{ form_label(address)|replace({'[-br]': '<br>', '[-span]': '<span>', '[-/span]': '</span>'})|raw }}
				</div>
			{% endfor %}
			{{ form_end(form) }}

		</div> #}
		<div class="order-recap">
			<h2>Récapitulatif de la
				<span>Commande</span>
			</h2>


			{% set orderTotal = 0 %}
			{% for item in data %}
				{# {{ dump(item) }} #}
				<div class="cart-product">
					<div class="cart-product-image">
						<img src="{{ vich_uploader_asset(item.product.productImages[0], 'imageFile') }}" alt="{{ item.product.productImages[0].name }}">
					</div>
					<div class="cart-product-information">
						<h2>{{ item.product.name |capitalize}}
							{% for information in item.product.information %}
								{% if information.key == "mouvement" %}
									<span>
										{{ information.value |capitalize }}
									</span>
								{% endif %}
							{% endfor %}
						</h2>
						<h3>
							{% for information in item.product.information %}
								{% if information.key == "watchNumber" or information.key == "materiaux" %}
									{{ information.value }}
								{% endif %}
							{% endfor %}
						</h3>
						{% set highestPriorityDiscount = null %}
						{% set highestPriority = -1 %}
						{% set currentDate = "now"|date('Y-m-d H:i:s') %}
						{% for category in item.product.category %}
							{% for discount in category.discounts %}
								{% if discount.active == true and (discount.startDate is null or discount.startDate|date('Y-m-d H:i:s') <= currentDate) %}
									{% if discount.endDate is null or discount.endDate|date('Y-m-d H:i:s') >= currentDate %}
										{% if discount.priority > highestPriority %}
											{% set highestPriorityDiscount = discount %}
											{% set highestPriority = discount.priority %}
										{% endif %}
									{% endif %}
								{% endif %}
							{% endfor %}
						{% endfor %}
						<div class="cart-product-price-container">
							{% if highestPriorityDiscount is not null %}
								{% set discountedPrice = item.product.unitPrice %}
								{% if highestPriorityDiscount.percentageDiscount is not null %}
									{% set discountedPrice = discountedPrice - (discountedPrice * (highestPriorityDiscount.percentageDiscount / 100)) %}
								{% endif %}
								{% if highestPriorityDiscount.amountDiscount is not null %}
									{% set discountedPrice = discountedPrice - highestPriorityDiscount.amountDiscount %}
								{% endif %}
								{% set orderTotal = orderTotal + discountedPrice %}

								<h3>
									{{ discountedPrice|number_format(0, '.', ' ') }}
									€
									<span>
										{{ item.product.unitPrice|number_format(0, '.', ' ') }}
										€
									</span>
								</h3>
							{% else %}
								{% set orderTotal = orderTotal + item.product.unitPrice %}
								<h3>
									{{ item.product.unitPrice|number_format(0, '.', ' ') }}
									€
								</h3>
							{% endif %}
							{% if highestPriorityDiscount is not null %}
								{% if highestPriorityDiscount.percentageDiscount is not null %}
									<span>
										-{{ highestPriorityDiscount.percentageDiscount }}%
									</span>
								{% endif %}
								{% if highestPriorityDiscount.amountDiscount is not null %}
									<span>
										-{{ highestPriorityDiscount.amountDiscount }}€
									</span>
								{% endif %}
							{% endif %}
							<span>TVA Incluse</span>
						</div>
					</div>
				</div>
			{% endfor %}
			<div class="container-cart-total">
				<h3>Total :
					{{ orderTotal|number_format(0, '.', ' ') }}
					€</h3>
				<span>TVA Incluse</span>
			</div>

			<form method="POST" action="{{path('app_order_create_session_stripe')}}">
				<button>
					Payer avec Stripe
					<svg width="20" height="21" viewbox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
						<g clip-path="url(#clip0_324_848)">
							<path d="M9.83755 20.2318L17.626 12.4434L16.7037 11.521L8.91524 19.3095L9.83755 20.2318Z" fill="white"/>
							<path d="M18.9078 11.4707L19.8301 10.5483L9.88947 0.607729L8.96715 1.53004L18.9078 11.4707Z" fill="white"/>
						</g>
						<defs>
							<clipPath id="clip0_324_848">
								<rect width="20" height="20" fill="white" transform="translate(0 0.555664)"/>
							</clipPath>
						</defs>
					</svg>
				</button>
			</form>
		</div>
	</section>
{% endblock %}
